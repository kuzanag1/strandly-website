<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Integration Test - Strandly</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8f9fa;
        }
        .test-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #495057;
            margin-top: 0;
        }
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-weight: 500;
        }
        .status.pending { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        
        pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            border-left: 4px solid #007bff;
        }
        
        .test-step {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .test-step.running {
            border-color: #ffc107;
            background: #fff8e1;
        }
        
        .test-step.passed {
            border-color: #28a745;
            background: #f8fff9;
        }
        
        .test-step.failed {
            border-color: #dc3545;
            background: #fff5f5;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Strandly Payment Integration Test Suite</h1>
        <p>This page tests the complete payment integration flow from quiz completion to payment success.</p>
        
        <div class="status" id="overall-status">
            <strong>Overall Status:</strong> Ready to test
        </div>
        
        <button onclick="runFullTest()">üöÄ Run Complete Test</button>
        <button onclick="runIndividualTests()">üîç Run Individual Tests</button>
        <button onclick="clearResults()">üßπ Clear Results</button>
    </div>

    <div class="test-container">
        <h2>Test Results</h2>
        <div id="test-results">
            <p>Click "Run Complete Test" to start testing the payment integration.</p>
        </div>
    </div>

    <div class="test-container">
        <h2>Configuration Check</h2>
        <div id="config-check">
            <p>Checking configuration...</p>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/api-service.js"></script>
    <script>
        class PaymentIntegrationTester {
            constructor() {
                this.testResults = [];
                this.currentQuizId = null;
            }

            async runConfigurationCheck() {
                const configEl = document.getElementById('config-check');
                
                const checks = [
                    {
                        name: 'Config Loaded',
                        check: () => !!window.StrandlyConfig,
                        details: window.StrandlyConfig ? 'Config object available' : 'Config not loaded'
                    },
                    {
                        name: 'API URL Set',
                        check: () => !!window.StrandlyConfig?.getApiUrl(),
                        details: window.StrandlyConfig?.getApiUrl() || 'No API URL'
                    },
                    {
                        name: 'Stripe Key Set',
                        check: () => !!window.StrandlyConfig?.STRIPE?.publishableKey,
                        details: window.StrandlyConfig?.STRIPE?.publishableKey ? 'Key present' : 'No Stripe key'
                    },
                    {
                        name: 'API Service Loaded',
                        check: () => !!window.StrandlyApi,
                        details: window.StrandlyApi ? 'API service ready' : 'API service not loaded'
                    }
                ];

                let configHtml = '<h3>Configuration Status</h3>';
                checks.forEach(({ name, check, details }) => {
                    const passed = check();
                    const status = passed ? '‚úÖ' : '‚ùå';
                    const color = passed ? 'green' : 'red';
                    configHtml += `<div style="color: ${color};">${status} ${name}: ${details}</div>`;
                });

                configEl.innerHTML = configHtml;
            }

            async runFullTest() {
                console.log('üöÄ Starting complete payment integration test...');
                
                this.updateOverallStatus('Running complete test suite...', 'pending');
                this.clearTestResults();

                const tests = [
                    { name: 'Backend Health Check', fn: this.testBackendHealth },
                    { name: 'Quiz Submission', fn: this.testQuizSubmission },
                    { name: 'Payment Session Creation', fn: this.testPaymentCreation },
                    { name: 'Payment Intent Creation', fn: this.testPaymentIntent },
                    { name: 'Frontend Integration', fn: this.testFrontendIntegration }
                ];

                let allPassed = true;

                for (const test of tests) {
                    try {
                        await this.runSingleTest(test.name, test.fn.bind(this));
                    } catch (error) {
                        allPassed = false;
                        this.logError(test.name, error);
                    }
                }

                const status = allPassed ? 'success' : 'error';
                const message = allPassed ? 'All tests passed! ‚úÖ' : 'Some tests failed ‚ùå';
                this.updateOverallStatus(message, status);
            }

            async runSingleTest(name, testFn) {
                const testEl = this.createTestElement(name);
                testEl.className = 'test-step running';
                
                try {
                    console.log(`Running test: ${name}`);
                    const result = await testFn();
                    
                    testEl.className = 'test-step passed';
                    testEl.innerHTML += `<div style="color: green;">‚úÖ PASSED</div>`;
                    
                    if (result.details) {
                        testEl.innerHTML += `<pre>${JSON.stringify(result.details, null, 2)}</pre>`;
                    }
                    
                    return result;
                } catch (error) {
                    console.error(`Test failed: ${name}`, error);
                    
                    testEl.className = 'test-step failed';
                    testEl.innerHTML += `<div style="color: red;">‚ùå FAILED: ${error.message}</div>`;
                    testEl.innerHTML += `<pre>${error.stack || error}</pre>`;
                    
                    throw error;
                }
            }

            async testBackendHealth() {
                const apiUrl = window.StrandlyConfig.getApiUrl();
                const response = await fetch(`${apiUrl}/health`);
                
                if (!response.ok) {
                    throw new Error(`Health check failed: ${response.status}`);
                }
                
                const data = await response.json();
                return { success: true, details: data };
            }

            async testQuizSubmission() {
                const testQuizData = {
                    'hair-concern': 'My hair feels dry and lifeless üíß',
                    'hair-length': 'Medium length (shoulder to chest) üìè',
                    'wash-frequency': '2-3 times per week ‚≠ê',
                    'hair-texture': 'Wavy (with some natural movement) üåä',
                    'hair-thickness': 'Medium (just right balance) ‚öñÔ∏è',
                    'hair-porosity': 'Slowly sinks to the bottom üêå',
                    'scalp-type': 'Pretty normal & balanced ‚úÖ',
                    'chemical-treatments': ['None - I keep it natural üåø'],
                    'lifestyle-factors': ['None of these ‚úÖ'],
                    'email': 'test@strandly.com'
                };

                const result = await window.StrandlyApi.submitQuiz(testQuizData);
                
                if (!result.quizId) {
                    throw new Error('Quiz submission did not return quiz ID');
                }
                
                this.currentQuizId = result.quizId;
                return { success: true, details: result };
            }

            async testPaymentCreation() {
                if (!this.currentQuizId) {
                    throw new Error('No quiz ID available. Run quiz submission test first.');
                }

                const apiUrl = window.StrandlyConfig.getApiUrl();
                const response = await fetch(`${apiUrl}/api/payment/create-checkout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quizId: this.currentQuizId })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Payment creation failed: ${errorData.details || response.statusText}`);
                }

                const data = await response.json();
                
                if (!data.sessionId || !data.url) {
                    throw new Error('Payment session missing sessionId or URL');
                }

                return { success: true, details: data };
            }

            async testPaymentIntent() {
                if (!this.currentQuizId) {
                    throw new Error('No quiz ID available. Run quiz submission test first.');
                }

                const apiUrl = window.StrandlyConfig.getApiUrl();
                const response = await fetch(`${apiUrl}/api/payment/create-intent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quizId: this.currentQuizId })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Payment intent failed: ${errorData.details || response.statusText}`);
                }

                const data = await response.json();
                
                if (!data.clientSecret) {
                    throw new Error('Payment intent missing client secret');
                }

                return { success: true, details: data };
            }

            async testFrontendIntegration() {
                // Test that all required frontend components are available
                const checks = [
                    { name: 'Stripe loaded', check: () => typeof Stripe !== 'undefined' },
                    { name: 'Config available', check: () => !!window.StrandlyConfig },
                    { name: 'API service available', check: () => !!window.StrandlyApi },
                    { name: 'Payment integration script', check: () => !!window.StrandlyPaymentIntegration }
                ];

                const results = {};
                let allPassed = true;

                for (const check of checks) {
                    const passed = check.check();
                    results[check.name] = passed ? 'PASS' : 'FAIL';
                    if (!passed) allPassed = false;
                }

                if (!allPassed) {
                    throw new Error('Some frontend integration checks failed');
                }

                return { success: true, details: results };
            }

            createTestElement(name) {
                const resultsEl = document.getElementById('test-results');
                const testEl = document.createElement('div');
                testEl.className = 'test-step';
                testEl.innerHTML = `<h3>${name}</h3><div>Running...</div>`;
                resultsEl.appendChild(testEl);
                return testEl;
            }

            updateOverallStatus(message, type) {
                const statusEl = document.getElementById('overall-status');
                statusEl.className = `status ${type}`;
                statusEl.innerHTML = `<strong>Overall Status:</strong> ${message}`;
            }

            clearTestResults() {
                document.getElementById('test-results').innerHTML = '';
            }

            logError(testName, error) {
                console.error(`Test "${testName}" failed:`, error);
            }
        }

        // Global functions for the UI
        let tester;

        function initTester() {
            tester = new PaymentIntegrationTester();
            tester.runConfigurationCheck();
        }

        function runFullTest() {
            if (!tester) initTester();
            tester.runFullTest();
        }

        function runIndividualTests() {
            alert('Individual test mode not implemented yet. Use "Run Complete Test" for now.');
        }

        function clearResults() {
            if (tester) {
                tester.clearTestResults();
                tester.updateOverallStatus('Ready to test', 'pending');
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üß™ Payment Integration Test Page Loaded');
            
            // Wait for dependencies to load
            setTimeout(() => {
                initTester();
            }, 1000);
        });
    </script>
</body>
</html>